# Notes on RcppTskit package development

## Next TODOs

# Release (TODO)
# TODO: Tag a release #15
#       https://github.com/HighlanderLab/RcppTskit/issues/15
# remotes::install_github("HighlanderLab/RcppTskit/RcppTskit")

# Main branch
remotes::install_github("HighlanderLab/RcppTskit/RcppTskit")

# TODO: Create a devel branch #16
#       https://github.com/HighlanderLab/RcppTskit/issues/16
# remotes::install_github("HighlanderLab/RcppTskit/RcppTskit@devel")

# TODO: Publish on CRAN #14
#       https://github.com/HighlanderLab/RcppTskit/issues/14

* This PR nicely shows how slendr is dealing with ts objects
  (it saves various ts information as attributes)
  https://github.com/bodkan/slendr/pull/191/changes#diff-f46eb0da2f9267022ecc6e09316598fde6bdcd2f980963906dc041b5096f344f

* TODO Tskit examples of building tree sequence in C
extern/tskit/c/tests/testlib.c has lots of examples of constructing a tree sequence using C
extern/tskit/c/tests/test_minimal_cpp.cpp has some C++ example too
extern/tskit/c/examples/haploid_wright_fisher.c
extern/tskit/c/examples/multichrom_wright_fisher_singlethreaded.c
extern/tskit/c/examples/multichrom_wright_fisher.c

This test nicely shows the required columns:

static void
test_missing_required_columns(void)
{
    int ret;
    size_t j;
    tsk_treeseq_t *ts = caterpillar_tree(5, 3, 3);
    tsk_table_collection_t t;
    const char *required_cols[] = {
        "edges/child",
        "edges/left",
        "edges/parent",
        "edges/right",
        "format/name",
        "format/version",
        "individuals/flags",
        "migrations/dest",
        "migrations/left",
        "migrations/node",
        "migrations/right",
        "migrations/source",
        "migrations/time",
        "mutations/node",
        "mutations/parent",
        "mutations/site",
        "nodes/flags",
        "nodes/individual",
        "nodes/population",
        "nodes/time",
        "sequence_length",
        "sites/position",
        "uuid",
    };
    const char *drop_cols[1];

    for (j = 0; j < sizeof(required_cols) / sizeof(*required_cols); j++) {
        drop_cols[0] = required_cols[j];
        copy_store_drop_columns(ts, 1, drop_cols, _tmp_file_name);
        ret = tsk_table_collection_load(&t, _tmp_file_name, 0);
        CU_ASSERT_EQUAL_FATAL(ret, TSK_ERR_REQUIRED_COL_NOT_FOUND);
        tsk_table_collection_free(&t);
    }

    tsk_treeseq_free(ts);
    free(ts);
}

## NEWS template

```
## [Unreleased] - YYYY-MM-DD

Routinely log changes in the package ...

## [MAJOR.MINOR.PATCH] - YYYY-MM-DD

MAJOR version when you make incompatible API changes
MINOR version when you add functionality in a backward compatible manner
PATCH version when you make backward compatible bug fixes

### Added (new features)

- Describe 1 ...
- Describe 2 ...

### Changed (for )changes in existing functionality)
### Deprecated (soon-to-be removed features)
### Removed (now removed features)
### Fixed (bug fixes)
### Security (vulnerabilities)
```

## Setup

```
install.packages(c("usethis", "devtools"))
```

## Code testing coverage with covr

https://covr.r-lib.org

```
install.packages("covr")

# https://usethis.r-lib.org/reference/use_coverage.html
usethis::use_coverage(type = "codecov")

# Build the report
cov <- covr::package_coverage(clean = TRUE)

# Interactive HTML report with uncovered lines highlighted
covr::report(cov)

# List lines with zero coverage per file
covr::zero_coverage(cov)

# Show coverage for a specific file
covr::report(cov, file = "R/RcppTskit-package.R")
covr::report(cov, file = "src/RcppTskit_minimal.cpp")

# If you want a quick text view of uncovered lines:
covr::file_coverage("R/RcppTskit-package.R", "tests/testthat")
covr::file_coverage("src/RcppTskit_minimal.cpp", "tests/testthat")
```

To ignore specific lines, use `# nocov`

To ignore multiple lines use `# nocov start/stop`.

In `Rcpp` code use `// # nocov ...`.

## Air formatter of R code

https://usethis.r-lib.org/reference/use_air.html
```
usethis::use_air()
```

https://posit-dev.github.io/air

Setup editor and `air.toml`.

In comand line, run:

```
air format .
air format --check .
```

## Jarl linter of R code

https://jarl.etiennebacher.com

Setup editor and `jarl.toml`. Can also do `~/.config/jarl`.

```
jarl check .
jarl check --fix .
```

## clang-format of C/C++ code

https://clang.llvm.org/docs/ClangFormat.html

```
# All files (run from the RcppTskit directory)
find src -type f \( -name '*.c' -o -name '*.cpp' -o -name '*.h' -o -name '*.hpp' \) \
  ! -path 'inst/include/tskit/*' \
  ! -path 'src/tskit/*' \
  ! -path 'src/RcppExports.cpp' \
  -exec clang-format -i {} +

# All files (run from the repo root)
find . -type f \( -name '*.c' -o -name '*.cpp' -o -name '*.h' -o -name '*.hpp' \) \
  ! -path './extern/*' \
  ! -path './RcppTskit/inst/include/tskit/*' \
  ! -path './RcppTskit/src/tskit/*' \
  ! -path './RcppTskit/src/RcppExports.cpp' \
  -exec clang-format -i {} +

# Single file
clang-format -i --style=file src/RcppTskit_minimal.cpp

# Only changes
git diff --name-only main | grep -E '\.(c|cpp|h|hpp)$' | xargs clang-format -i
```

or

```
pre-commit run clang-format src/RcppTskit.cpp
pre-commit run clang-format --all-files
```

## clang-tidy linter of C/C++ code

https://clang.llvm.org/extra/clang-tidy/

```
echo $(brew --prefix llvm)/bin/clang-tidy
# /opt/homebrew/opt/llvm/bin/clang-tidy
export CLANG_TIDY="$(brew --prefix llvm)/bin/clang-tidy"
./tools/clang-tidy.py src/RcppTskit.cpp
./RcppTskit/tools/clang-tidy.py RcppTskit/src/test_tsk_abort_stderr.cpp -- -system-headers '-header-filter=.*'   -extra-arg=-Wno-unknown-warning-option
./tools/clang-tidy.py src/test_tsk_abort_stderr.cpp -- -system-headers '-header-filter=.*'   -extra-arg=-Wno-unknown-warning-option
```

or

```
pre-commit run clang-tidy src/RcppTskit.cpp
pre-commit run clang-tidy --all-files
```

## GitHub actions

```
install.packages("usethis")

# R CMD check
usethis::use_github_action("check-standard")

# Code testing coverage with covr
usethis::use_github_action("test-coverage")

# Air formatting --> moved to pre-commit
usethis::use_github_action(url = "https://github.com/posit-dev/setup-air/blob/main/examples/format-suggest.yaml")
usethis::use_github_action(url = "https://github.com/posit-dev/setup-air/blob/main/examples/format-check.yaml")
```
