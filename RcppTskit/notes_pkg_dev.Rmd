# Notes on RcppTskit package development

## Next TODOs

* TODO: Should we also use https://tskit.dev/tskit/docs/stable/c-api.html#c.TSK_TS_INIT_COMPUTE_MUTATION_PARENTS?
  in TableCollection$tree_sequence()?

* Test how skip_ref_seq works?

* Test building indexes?

* Will we need tc$sort() and stuff or is the default in tc$tree_sequence() OK?

* Do we want to expose ts discrete_time or discrete_genome properties?
  Also we have this comment in RcppTskit.cpp

// See tsk_treeseq_t inst/include/tskit/tskit/trees.h on what it contains. Here
// is Python summary
// https://tskit.dev/tskit/docs/stable/python-api.html#trees-and-tree-sequences
// See tsk_table_collection_t inst/include/tskit/tskit/tables.h on what it
// contains. Here is Python summary
// https://tskit.dev/tskit/docs/stable/python-api.html#sec-tables-api-table-collection

# Release (TODO)
# TODO: Tag a release #15
#       https://github.com/HighlanderLab/RcppTskit/issues/15
# remotes::install_github("HighlanderLab/RcppTskit/RcppTskit")

# TODO: Publish on CRAN #14
#       https://github.com/HighlanderLab/RcppTskit/issues/14

// TODO: This will go into AlphaSimR
// [[Rcpp::export]]
SEXP tc_grow(SEXP tc) {
  RcppTskit_table_collection_xptr tc_xptr(tc);
  int ret;
  ret = 0;
  // TODO: What do we need to do here now? How do we grow a tree sequence?
  //       Look into the simple example in C code online or look into what SLiM
  //       is doing!?
  if (ret != 0) {
    // TODO: What should we do if something goes wrong? We can clearly throw an
    //       error using Rcpp::stop(), but should we also do something with the
    //       ts pointer and object? If we delete, we discard/delete past work,
    //       but if we don't, do we risk of returning a corrupted ts?
    // tsk_table_collection_free(tc_ptr);
    // delete tc_ptr;
    Rcpp::stop(tsk_strerror(ret));
  }
  return tc_xptr;
  // or do we want to return ts?
}

* This PR nicely shows how slendr is dealing with ts objects
  (it saves various ts information as attributes)
  https://github.com/bodkan/slendr/pull/191/changes#diff-f46eb0da2f9267022ecc6e09316598fde6bdcd2f980963906dc041b5096f344f

* TODO Tskit examples of building tree sequence in C
extern/tskit/c/tests/testlib.c has lots of examples of constructing a tree sequence using C
extern/tskit/c/tests/test_minimal_cpp.cpp has some C++ example too
extern/tskit/c/examples/haploid_wright_fisher.c
extern/tskit/c/examples/multichrom_wright_fisher_singlethreaded.c
extern/tskit/c/examples/multichrom_wright_fisher.c

This test nicely shows the required columns:

static void
test_missing_required_columns(void)
{
    int ret;
    size_t j;
    tsk_treeseq_t *ts = caterpillar_tree(5, 3, 3);
    tsk_table_collection_t t;
    const char *required_cols[] = {
        "edges/child",
        "edges/left",
        "edges/parent",
        "edges/right",
        "format/name",
        "format/version",
        "individuals/flags",
        "migrations/dest",
        "migrations/left",
        "migrations/node",
        "migrations/right",
        "migrations/source",
        "migrations/time",
        "mutations/node",
        "mutations/parent",
        "mutations/site",
        "nodes/flags",
        "nodes/individual",
        "nodes/population",
        "nodes/time",
        "sequence_length",
        "sites/position",
        "uuid",
    };
    const char *drop_cols[1];

    for (j = 0; j < sizeof(required_cols) / sizeof(*required_cols); j++) {
        drop_cols[0] = required_cols[j];
        copy_store_drop_columns(ts, 1, drop_cols, _tmp_file_name);
        ret = tsk_table_collection_load(&t, _tmp_file_name, 0);
        CU_ASSERT_EQUAL_FATAL(ret, TSK_ERR_REQUIRED_COL_NOT_FOUND);
        tsk_table_collection_free(&t);
    }

    tsk_treeseq_free(ts);
    free(ts);
}

## NEWS template

```
## [Unreleased] - YYYY-MM-DD

Routinely log changes in the package ...

## [MAJOR.MINOR.PATCH] - YYYY-MM-DD

MAJOR version when you make incompatible API changes
MINOR version when you add functionality in a backward compatible manner
PATCH version when you make backward compatible bug fixes

### Added (new features)

- Describe 1 ...
- Describe 2 ...

### Changed (for )changes in existing functionality)
### Deprecated (soon-to-be removed features)
### Removed (now removed features)
### Fixed (bug fixes)
### Security (vulnerabilities)
```

## Prepare for release

```
use_upkeep_issue(year = NULL) # https://usethis.r-lib.org/reference/use_upkeep_issue.html
use_release_issue(version = NULL) # https://usethis.r-lib.org/reference/use_release_issue.html
# just follow tasks in there;)
```

## Dev tools setup / use

```
install.packages(c("usethis", "devtools"))
```

### Code testing coverage with covr

https://covr.r-lib.org

```
install.packages("covr")

# https://usethis.r-lib.org/reference/use_coverage.html
usethis::use_coverage(type = "codecov")

# Build the report & report
cov <- covr::package_coverage(clean = TRUE); covr::report(cov)

# Build the report
cov <- covr::package_coverage(clean = TRUE)

# Interactive HTML report with uncovered lines highlighted
covr::report(cov)

# List lines with zero coverage per file
covr::zero_coverage(cov)

# Show coverage for a specific file
covr::report(cov, file = "R/RcppTskit-package.R")
covr::report(cov, file = "src/RcppTskit_minimal.cpp")

# If you want a quick text view of uncovered lines:
covr::file_coverage("R/RcppTskit-package.R", "tests/testthat")
covr::file_coverage("src/RcppTskit_minimal.cpp", "tests/testthat")
```

To ignore specific lines, use `# nocov`

To ignore multiple lines use `# nocov start/stop`.

In `Rcpp` code use `// # nocov ...`.

### Debugging C/C++

In `src/Makevars.in` uncomment debug flags ...

From terminal run:

```
# Go to package folder
R_HOME="/Library/Frameworks/R.framework/Resources"
R_BIN="$R_HOME/bin/exec/R"
ASAN="/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/clang/17/lib/darwin/libclang_rt.asan_osx_dynamic.dylib"
UBSAN="/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/clang/17/lib/darwin/libclang_rt.ubsan_osx_dynamic.dylib"

env R_HOME="$R_HOME" \
  DYLD_INSERT_LIBRARIES="$ASAN:$UBSAN" \
  ASAN_OPTIONS="abort_on_error=1,detect_leaks=0,verbosity=1" \
  UBSAN_OPTIONS="print_stacktrace=1" \
  "$R_BIN" --vanilla
```

In the R session (not from Rstudio/Positron!):

```
# Load + compile into the current ASan session (no child R load)
devtools::load_all()

# Run tests in the same process
devtools::test()
```

### Air formatter of R code

https://usethis.r-lib.org/reference/use_air.html
```
usethis::use_air()
```

https://posit-dev.github.io/air

Setup editor and `air.toml`.

In comand line, run:

```
air format .
air format --check .
```

### Jarl linter of R code

https://jarl.etiennebacher.com

Setup editor and `jarl.toml`. Can also do `~/.config/jarl`.

```
jarl check .
jarl check --fix .
```

### clang-format of C/C++ code

https://clang.llvm.org/docs/ClangFormat.html

```
# All files (run from the RcppTskit directory)
find src -type f \( -name '*.c' -o -name '*.cpp' -o -name '*.h' -o -name '*.hpp' \) \
  ! -path 'inst/include/tskit/*' \
  ! -path 'src/tskit/*' \
  ! -path 'src/RcppExports.cpp' \
  -exec clang-format -i {} +

# All files (run from the repo root)
find . -type f \( -name '*.c' -o -name '*.cpp' -o -name '*.h' -o -name '*.hpp' \) \
  ! -path './extern/*' \
  ! -path './RcppTskit/inst/include/tskit/*' \
  ! -path './RcppTskit/src/tskit/*' \
  ! -path './RcppTskit/src/RcppExports.cpp' \
  -exec clang-format -i {} +

# Single file
clang-format -i --style=file src/RcppTskit_minimal.cpp

# Only changes
git diff --name-only main | grep -E '\.(c|cpp|h|hpp)$' | xargs clang-format -i
```

or

```
pre-commit run clang-format src/RcppTskit.cpp
pre-commit run clang-format --all-files
```

### clang-tidy linter of C/C++ code

https://clang.llvm.org/extra/clang-tidy/

```
echo $(brew --prefix llvm)/bin/clang-tidy
# /opt/homebrew/opt/llvm/bin/clang-tidy
export CLANG_TIDY="$(brew --prefix llvm)/bin/clang-tidy"
./tools/clang-tidy.py src/RcppTskit.cpp
./RcppTskit/tools/clang-tidy.py RcppTskit/src/test_tsk_abort_stderr.cpp -- -system-headers '-header-filter=.*'   -extra-arg=-Wno-unknown-warning-option
./tools/clang-tidy.py src/test_tsk_abort_stderr.cpp -- -system-headers '-header-filter=.*'   -extra-arg=-Wno-unknown-warning-option
```

or

```
pre-commit run clang-tidy src/RcppTskit.cpp
pre-commit run clang-tidy --all-files
```

### GitHub actions

```
install.packages("usethis")

# R CMD check
usethis::use_github_action("check-standard")

# Code testing coverage with covr
usethis::use_github_action("test-coverage")

# Air formatting --> moved to pre-commit
usethis::use_github_action(url = "https://github.com/posit-dev/setup-air/blob/main/examples/format-suggest.yaml")
usethis::use_github_action(url = "https://github.com/posit-dev/setup-air/blob/main/examples/format-check.yaml")
```
