# tskit C sources & objects
# TSKIT_SOURCES = $(wildcard tskit/*.c) # wildcard is a GNU extension and not desired on CRAN
TSKIT_SOURCES = \
	tskit/convert.c \
	tskit/core.c \
	tskit/genotypes.c \
	tskit/haplotype_matching.c \
	tskit/kastore.c \
	tskit/stats.c \
	tskit/tables.c \
	tskit/trees.c
# $(info TSKIT_SOURCES = $(TSKIT_SOURCES)) # for debugging, info is also a GNU extension
TSKIT_OBJECTS = $(TSKIT_SOURCES:.c=.o)
# $(info TSKIT_OBJECTS = $(TSKIT_OBJECTS)) # for debugging, info is also a GNU extension

# RcppTskit C/C++ sources & objects
RCPPTSKIT_C_SOURCES = \
	tests_c.c
# $(info RCPPTSKIT_C_SOURCES = $(RCPPTSKIT_C_SOURCES)) # for debugging, info is also a GNU extension
# RCPPTSKIT_CPP_SOURCES = $(wildcard *.cpp) # wildcard is a GNU extension and not desired on CRAN
RCPPTSKIT_CPP_SOURCES = \
	RcppTskit.cpp \
	tests.cpp \
	RcppExports.cpp
# $(info RCPPTSKIT_CPP_SOURCES = $(RCPPTSKIT_CPP_SOURCES)) # for debugging, info is also a GNU extension
RCPPTSKIT_OBJECTS = $(RCPPTSKIT_C_SOURCES:.c=.o) $(RCPPTSKIT_CPP_SOURCES:.cpp=.o)
# $(info RCPPTSKIT_OBJECTS = $(RCPPTSKIT_OBJECTS)) # for debugging, info is also a GNU extension

# All objects
OBJECTS = $(TSKIT_OBJECTS) $(RCPPTSKIT_OBJECTS)
# $(info OBJECTS = $(OBJECTS)) # for debugging, info is also a GNU extension

# *Preprocessor (CPP)* flags for include paths and defines
# * A bit complicated include/tskit structure due to how we include tskit headers
# * $(R_INCLUDE_DIR) is for <R_ext/Error.h>
PKG_CPPFLAGS = \
	-I../inst/include \
	-I../inst/include/tskit \
	-I../inst/include/tskit/tskit \
	-I$(R_INCLUDE_DIR)

# *Compiler (C/CXX)* flags
# Uncomment for local debugging
# SAN_FLAGS enables ASan/UBSan to catch memory/UB errors in dev builds (only run R in terminal!)
# TSK_TRACE_ERRORS enables tskit C error tracing
# DEBUG_OPT = -g -O1 # -O1 is needed for many of the below flags
# WARN_FLAGS = $(DEBUG_OPT) -Wall -Wextra -Wpedantic -Wuninitialized
# SAN_FLAGS = $(DEBUG_OPT) -fno-omit-frame-pointer -fsanitize=address,undefined -fno-common
# DEV_FLAGS = $(SAN_FLAGS) $(WARN_FLAGS) -DTSK_TRACE_ERRORS
# RCPPTSKIT_CFLAGS = $(DEV_FLAGS)
# RCPPTSKIT_CXXFLAGS = $(DEV_FLAGS)
# RCPPTSKIT_LDFLAGS = -fsanitize=address,undefined
# Uncomment for release builds
# NDEBUG removes calls to assert()
RCPPTSKIT_CFLAGS = -DNDEBUG
RCPPTSKIT_CXXFLAGS = -DNDEBUG
RCPPTSKIT_LDFLAGS =
# Use the above choices
PKG_CFLAGS = $(RCPPTSKIT_CFLAGS)
PKG_CXXFLAGS = $(RCPPTSKIT_CXXFLAGS)

# core.h:__tsk_nan_f requires C++20 on CRAN/Windows, but see #63
CXX_STD = CXX20

# Explicit compile rule for tskit C files
tskit/%.o: tskit/%.c
	$(CC) $(ALL_CPPFLAGS) $(PKG_CFLAGS) $(CFLAGS) $(CPICFLAGS) -c $< -o $@

# Linking
PKG_LIBS = @RCPPTSKIT_LIB@ $(RCPPTSKIT_LDFLAGS)
